# 地址计算与温度区间代码总结

## 1. 地址计算相关代码

### 1.1 成员变量定义

```csharp
// 频率和温度索引值，用于计算地址
private int fre = 1;  // 频率索引：1=3330MHz, 2=3350MHz, 3=3370MHz, 4=3390MHz
private int tem = 1;  // 温度索引：根据温度区间计算

// 地址数组（十进制）
private int[] normal_addr_dec = new int[20];   // 正常地址，20个元素
private int[] cannel_addr_dec = new int[15];   // 通道地址，15个元素
private int[] antenna_addr_dec = new int[15];  // 天线地址，15个元素
private int[] db36_addr_dec = new int[20];     // DB36地址，20个元素

// 地址数组（十六进制字符串格式 "0xXXXX"）
private string[] normal_addr = new string[20];
private string[] cannel_addr = new string[15];
private string[] antenna_addr = new string[15];
private string[] db36_addr = new string[20];
```

### 1.2 地址计算公式

```csharp
/// <summary>
/// 根据当前频率和温度索引计算所有地址
/// 公式说明：
/// - normal_startAddress: 正常区域起始地址 = (20 * 31) * (fre - 1) + 20 * (tem - 1) + 1
/// - cannel_startAddress: 通道区域起始地址 = 2480 + (15 * 31) * (fre - 1) + 15 * (tem - 1) + 1
/// - antenna_startAddress: 天线区域起始地址 = 4340 + (15 * 31) * (fre - 1) + 15 * (tem - 1) + 1
/// - db36_startAddress: DB36区域起始地址 = 33480 + (20 * 31) * (fre - 1) + 20 * (tem - 1) + 1
/// 
/// 参数说明：
/// - fre: 频率索引 (1-4)，对应4个频率点
/// - tem: 温度索引 (1,2,4,6,8,10,...)，根据温度区间数量计算
/// - 20, 15: 各类地址的数量
/// - 31: 每个频率点的地址间隔
/// - 2480, 4340, 33480: 各类地址的基地址偏移
/// </summary>
private void GetAddressArray()
{
    // 计算各类起始地址
    int normal_startAddress = (20 * 31) * (fre - 1) + 20 * (tem - 1) + 1;
    int cannel_startAddress = 2480 + (15 * 31) * (fre - 1) + 15 * (tem - 1) + 1;
    int antenna_startAddress = 4340 + (15 * 31) * (fre - 1) + 15 * (tem - 1) + 1;
    int db36_startAddress = 33480 + (20 * 31) * (fre - 1) + 20 * (tem - 1) + 1;

    // 生成20个元素的地址数组
    for (int i = 0; i < 20; i++)
    {
        normal_addr_dec[i] = normal_startAddress + i;
        db36_addr_dec[i] = db36_startAddress + i;
        normal_addr[i] = "0x" + normal_addr_dec[i].ToString("X4");
        db36_addr[i] = "0x" + db36_addr_dec[i].ToString("X4");
    }

    // 生成15个元素的地址数组
    for (int i = 0; i < 15; i++)
    {
        cannel_addr_dec[i] = cannel_startAddress + i;
        antenna_addr_dec[i] = antenna_startAddress + i;
        cannel_addr[i] = "0x" + cannel_addr_dec[i].ToString("X4");
        antenna_addr[i] = "0x" + antenna_addr_dec[i].ToString("X4");
    }
}
```

### 1.3 频率选择处理

```csharp
/// <summary>
/// 频率选择按钮点击事件处理
/// 根据选择的频率按钮设置 fre 索引值
/// </summary>
/// <param name="sender">点击的按钮</param>
private void FrequencyButton_Click(object sender, EventArgs e)
{
    RadioButton btn = sender as RadioButton;
    if (btn == null) return;

    switch (btn.Name)
    {
        case "button3330":
            fre = 1;  // 3330MHz
            break;
        case "button3350":
            fre = 2;  // 3350MHz
            break;
        case "button3370":
            fre = 3;  // 3370MHz
            break;
        case "button3390":
            fre = 4;  // 3390MHz
            break;
    }

    // 重新计算地址并更新控件
    GetAddressArray();
    UpdateAllControls();
}
```

### 1.4 温度选择处理

```csharp
/// <summary>
/// 温度下拉框选择事件处理
/// 根据选择的温度区间设置 tem 索引值
/// ComboBox项顺序: T<=-50, -50<T<=-40, -40<T<=-30, ...
/// </summary>
/// <param name="sender">下拉框控件</param>
/// <param name="e">事件参数</param>
private void comboBoxtemp_SelectedIndexChanged(object sender, EventArgs e)
{
    int index = comboBoxtemp.SelectedIndex;
    
    // 根据下拉框索引计算温度索引
    // 索引0对应tem=1，索引1对应tem=2，索引2开始tem=2*index
    if (index == 0) tem = 1;
    else if (index == 1) tem = 2;
    else tem = 2 * index;  // 例如：索引2->tem=4, 索引3->tem=6, 索引4->tem=8...

    // 重新计算地址并更新控件
    GetAddressArray();
    UpdateAllControls();
    
    // 显示地址更新警告
    labelWarning1.Visible = true;
    labelWarning2.Visible = true;
}
```

### 1.5 更新控件地址

```csharp
/// <summary>
/// 更新指定FlowLayoutPanel中所有BTNtest控件的地址
/// </summary>
/// <param name="panel">FlowLayoutPanel控件</param>
/// <param name="addresses">地址数组</param>
/// <param name="startIndex">起始索引</param>
/// <param name="count">要更新的数量</param>
private void UpdatePanelControls(FlowLayoutPanel panel, string[] addresses, int startIndex, int count)
{
    if (panel.Controls.Count < count) return;

    for (int i = 0; i < count; i++)
    {
        if (panel.Controls[i] is BTNtest btn)
        {
            btn.Addr = addresses[startIndex + i];
        }
    }
}

/// <summary>
/// 更新所有控件的地址信息
/// 按布局顺序更新各个FlowLayoutPanel中的控件
/// </summary>
private void UpdateAllControls()
{
    UpdatePanelControls(flowLayoutPanel1, normal_addr, 0, 10);
    UpdatePanelControls(flowLayoutPanel2, normal_addr, 10, 10);
    UpdatePanelControls(flowLayoutPanel3, cannel_addr, 0, 7);
    UpdatePanelControls(flowLayoutPanel4, cannel_addr, 7, 8);
    UpdatePanelControls(flowLayoutPanel5, antenna_addr, 0, 7);
    UpdatePanelControls(flowLayoutPanel6, antenna_addr, 7, 8);
    UpdatePanelControls(flowLayoutPanel7, db36_addr, 0, 10);
    UpdatePanelControls(flowLayoutPanel8, db36_addr, 10, 10);
}
```

## 2. 温度区间相关代码

### 2.1 温度区间定义

温度区间共16个，从-50℃到90℃以上：

```csharp
// ComboBox中应添加的项（按顺序）：
// 0: "T<=-50"
// 1: "-50<T<=-40"
// 2: "-40<T<=-30"
// 3: "-30<T<=-20"
// 4: "-20<T<=-10"
// 5: "-10<T<=0"
// 6: "0<T<=10"
// 7: "10<T<=20"
// 8: "20<T<=30"
// 9: "30<T<=40"
// 10: "40<T<=50"
// 11: "50<T<=60"
// 12: "60<T<=70"
// 13: "70<T<=80"
// 14: "80<T<=90"
// 15: "90<T"
```

### 2.2 温度区间获取函数

```csharp
/// <summary>
/// 根据温度值获取对应的温度区间字符串
/// 用于自动匹配温度下拉框选择
/// </summary>
/// <param name="temperature">当前温度值（摄氏度）</param>
/// <returns>对应的温度区间字符串</returns>
private string GetTemperatureRange(float temperature)
{
    if (temperature <= -50) return "T<=-50";
    if (temperature > -50 && temperature <= -40) return "-50<T<=-40";
    if (temperature > -40 && temperature <= -30) return "-40<T<=-30";
    if (temperature > -30 && temperature <= -20) return "-30<T<=-20";
    if (temperature > -20 && temperature <= -10) return "-20<T<=-10";
    if (temperature > -10 && temperature <= 0) return "-10<T<=0";
    if (temperature > 0 && temperature <= 10) return "0<T<=10";
    if (temperature > 10 && temperature <= 20) return "10<T<=20";
    if (temperature > 20 && temperature <= 30) return "20<T<=30";
    if (temperature > 30 && temperature <= 40) return "30<T<=40";
    if (temperature > 40 && temperature <= 50) return "40<T<=50";
    if (temperature > 50 && temperature <= 60) return "50<T<=60";
    if (temperature > 60 && temperature <= 70) return "60<T<=70";
    if (temperature > 70 && temperature <= 80) return "70<T<=80";
    if (temperature > 80 && temperature <= 90) return "80<T<=90";

    // 温度大于90
    return "90<T";
}
```

### 2.3 简化版温度区间映射（数组实现）

```csharp
// 如果需要更高效的温度区间判断，可以使用数组+二分查找：
private readonly (float min, float max, string range)[] TemperatureRanges = new[]
{
    (float.MinValue, -50f, "T<=-50"),
    (-50f, -40f, "-50<T<=-40"),
    (-40f, -30f, "-40<T<=-30"),
    (-30f, -20f, "-30<T<=-20"),
    (-20f, -10f, "-20<T<=-10"),
    (-10f, 0f, "-10<T<=0"),
    (0f, 10f, "0<T<=10"),
    (10f, 20f, "10<T<=20"),
    (20f, 30f, "20<T<=30"),
    (30f, 40f, "30<T<=40"),
    (40f, 50f, "40<T<=50"),
    (50f, 60f, "50<T<=60"),
    (60f, 70f, "60<T<=70"),
    (70f, 80f, "70<T<=80"),
    (80f, 90f, "80<T<=90"),
    (90f, float.MaxValue, "90<T")
};

private string GetTemperatureRangeOptimized(float temperature)
{
    foreach (var range in TemperatureRanges)
    {
        if (temperature >= range.min && temperature <= range.max)
        {
            return range.range;
        }
    }
    return "90<T";
}
```

### 2.4 温度区间与索引的映射

```csharp
/// <summary>
/// 将温度区间字符串转换为ComboBox索引
/// </summary>
/// <param name="temperatureRange">温度区间字符串</param>
/// <returns>ComboBox索引，-1表示未找到</returns>
private int TemperatureRangeToIndex(string temperatureRange)
{
    string[] ranges = new string[]
    {
        "T<=-50", "-50<T<=-40", "-40<T<=-30", "-30<T<=-20",
        "-20<T<=-10", "-10<T<=0", "0<T<=10", "10<T<=20",
        "20<T<=30", "30<T<=40", "40<T<=50", "50<T<=60",
        "60<T<=70", "70<T<=80", "80<T<=90", "90<T"
    };

    for (int i = 0; i < ranges.Length; i++)
    {
        if (ranges[i] == temperatureRange)
            return i;
    }
    return -1;
}

/// <summary>
/// 将ComboBox索引转换为温度索引值tem
/// </summary>
/// <param name="comboBoxIndex">ComboBox索引</param>
/// <returns>温度索引值tem</returns>
private int ComboBoxIndexToTempIndex(int comboBoxIndex)
{
    if (comboBoxIndex == 0) return 1;
    if (comboBoxIndex == 1) return 2;
    return 2 * comboBoxIndex;
}
```

## 3. 完整可移植的独立类

以下是一个完整的可移植类，包含地址计算和温度区间的所有功能：

```csharp
using System;
using System.Collections.Generic;
using System.Linq;

namespace DeviceControl
{
    /// <summary>
    /// 设备地址计算器
    /// 用于根据频率和温度索引计算各类EEPROM地址
    /// </summary>
    public class AddressCalculator
    {
        // 地址数组（十进制）
        private int[] normal_addr_dec = new int[20];
        private int[] channel_addr_dec = new int[15];
        private int[] antenna_addr_dec = new int[15];
        private int[] db36_addr_dec = new int[20];

        // 地址数组（十六进制字符串）
        private string[] normal_addr = new string[20];
        private string[] channel_addr = new string[15];
        private string[] antenna_addr = new string[15];
        private string[] db36_addr = new string[20];

        // 频率和温度索引
        public int FrequencyIndex { get; private set; } = 1;
        public int TemperatureIndex { get; private set; } = 1;

        // 频率配置
        public Dictionary<int, (int MHz, byte Code)> FrequencyConfig = new Dictionary<int, (int, byte)>
        {
            { 1, (3330, 0x00) },
            { 2, (3350, 0x01) },
            { 3, (3370, 0x02) },
            { 4, (3390, 0x03) }
        };

        /// <summary>
        /// 设置频率索引
        /// </summary>
        /// <param name="frequencyIndex">频率索引 (1-4)</param>
        public void SetFrequency(int frequencyIndex)
        {
            if (frequencyIndex < 1 || frequencyIndex > 4)
                throw new ArgumentOutOfRangeException(nameof(frequencyIndex));
            FrequencyIndex = frequencyIndex;
            RecalculateAddresses();
        }

        /// <summary>
        /// 设置温度索引
        /// </summary>
        /// <param name="temperatureIndex">温度索引 (1,2,4,6,8,...)</param>
        public void SetTemperature(int temperatureIndex)
        {
            if (temperatureIndex < 1)
                throw new ArgumentOutOfRangeException(nameof(temperatureIndex));
            TemperatureIndex = temperatureIndex;
            RecalculateAddresses();
        }

        /// <summary>
        /// 根据ComboBox索引设置温度
        /// </summary>
        /// <param name="comboBoxIndex">ComboBox索引 (0-15)</param>
        public void SetTemperatureFromComboBoxIndex(int comboBoxIndex)
        {
            if (comboBoxIndex == 0) TemperatureIndex = 1;
            else if (comboBoxIndex == 1) TemperatureIndex = 2;
            else TemperatureIndex = 2 * comboBoxIndex;
            RecalculateAddresses();
        }

        /// <summary>
        /// 重新计算所有地址
        /// </summary>
        private void RecalculateAddresses()
        {
            int fre = FrequencyIndex;
            int tem = TemperatureIndex;

            // 计算各类起始地址
            int normal_startAddress = (20 * 31) * (fre - 1) + 20 * (tem - 1) + 1;
            int channel_startAddress = 2480 + (15 * 31) * (fre - 1) + 15 * (tem - 1) + 1;
            int antenna_startAddress = 4340 + (15 * 31) * (fre - 1) + 15 * (tem - 1) + 1;
            int db36_startAddress = 33480 + (20 * 31) * (fre - 1) + 20 * (tem - 1) + 1;

            // 生成20个元素的地址数组
            for (int i = 0; i < 20; i++)
            {
                normal_addr_dec[i] = normal_startAddress + i;
                db36_addr_dec[i] = db36_startAddress + i;
                normal_addr[i] = "0x" + normal_addr_dec[i].ToString("X4");
                db36_addr[i] = "0x" + db36_addr_dec[i].ToString("X4");
            }

            // 生成15个元素的地址数组
            for (int i = 0; i < 15; i++)
            {
                channel_addr_dec[i] = channel_startAddress + i;
                antenna_addr_dec[i] = antenna_startAddress + i;
                channel_addr[i] = "0x" + channel_addr_dec[i].ToString("X4");
                antenna_addr[i] = "0x" + antenna_addr_dec[i].ToString("X4");
            }
        }

        // 属性访问器
        public string[] GetNormalAddresses() => normal_addr.ToArray();
        public string[] GetChannelAddresses() => channel_addr.ToArray();
        public string[] GetAntennaAddresses() => antenna_addr.ToArray();
        public string[] GetDb36Addresses() => db36_addr.ToArray();
        public int[] GetNormalAddressesDec() => normal_addr_dec.ToArray();
        public int[] GetChannelAddressesDec() => channel_addr_dec.ToArray();
        public int[] GetAntennaAddressesDec() => antenna_addr_dec.ToArray();
        public int[] GetDb36AddressesDec() => db36_addr_dec.ToArray();
    }

    /// <summary>
    /// 温度区间管理器
    /// 用于温度值与温度区间的转换
    /// </summary>
    public class TemperatureRangeManager
    {
        // 所有温度区间定义（按顺序）
        public static readonly string[] TemperatureRanges = new string[]
        {
            "T<=-50",      // 0
            "-50<T<=-40",  // 1
            "-40<T<=-30",  // 2
            "-30<T<=-20",  // 3
            "-20<T<=-10",  // 4
            "-10<T<=0",    // 5
            "0<T<=10",     // 6
            "10<T<=20",    // 7
            "20<T<=30",    // 8
            "30<T<=40",    // 9
            "40<T<=50",    // 10
            "50<T<=60",    // 11
            "60<T<=70",    // 12
            "70<T<=80",    // 13
            "80<T<=90",    // 14
            "90<T"         // 15
        };

        // 温度区间边界值
        private static readonly (float min, float max)[] RangeBounds = new[]
        {
            (float.MinValue, -50f),
            (-50f, -40f),
            (-40f, -30f),
            (-30f, -20f),
            (-20f, -10f),
            (-10f, 0f),
            (0f, 10f),
            (10f, 20f),
            (20f, 30f),
            (30f, 40f),
            (40f, 50f),
            (50f, 60f),
            (60f, 70f),
            (70f, 80f),
            (80f, 90f),
            (90f, float.MaxValue)
        };

        /// <summary>
        /// 根据温度值获取温度区间
        /// </summary>
        /// <param name="temperature">温度值</param>
        /// <returns>温度区间字符串</returns>
        public static string GetRange(float temperature)
        {
            for (int i = 0; i < RangeBounds.Length; i++)
            {
                if (temperature >= RangeBounds[i].min && temperature <= RangeBounds[i].max)
                {
                    return TemperatureRanges[i];
                }
            }
            return "90<T";
        }

        /// <summary>
        /// 根据温度值获取ComboBox索引
        /// </summary>
        /// <param name="temperature">温度值</param>
        /// <returns>ComboBox索引</returns>
        public static int GetComboBoxIndex(float temperature)
        {
            for (int i = 0; i < RangeBounds.Length; i++)
            {
                if (temperature >= RangeBounds[i].min && temperature <= RangeBounds[i].max)
                {
                    return i;
                }
            }
            return 15; // 默认返回最后一个索引
        }

        /// <summary>
        /// 将温度区间转换为ComboBox索引
        /// </summary>
        /// <param name="range">温度区间字符串</param>
        /// <returns>ComboBox索引，-1表示未找到</returns>
        public static int RangeToIndex(string range)
        {
            return Array.IndexOf(TemperatureRanges, range);
        }

        /// <summary>
        /// 将ComboBox索引转换为温度索引值
        /// </summary>
        /// <param name="comboBoxIndex">ComboBox索引</param>
        /// <returns>温度索引值</returns>
        public static int ComboBoxIndexToTempIndex(int comboBoxIndex)
        {
            if (comboBoxIndex == 0) return 1;
            if (comboBoxIndex == 1) return 2;
            return 2 * comboBoxIndex;
        }

        /// <summary>
        /// 将温度索引值转换为ComboBox索引
        /// </summary>
        /// <param name="tempIndex">温度索引值</param>
        /// <returns>ComboBox索引，-1表示未找到</returns>
        public static int TempIndexToComboBoxIndex(int tempIndex)
        {
            if (tempIndex == 1) return 0;
            if (tempIndex == 2) return 1;
            if (tempIndex % 2 == 0 && tempIndex >= 4)
                return tempIndex / 2;
            return -1;
        }

        /// <summary>
        /// 获取所有温度区间（用于绑定ComboBox）
        /// </summary>
        public static string[] GetAllRanges() => TemperatureRanges.ToArray();
    }
}
```

## 4. 使用示例

### 4.1 基本用法

```csharp
// 创建地址计算器实例
var addressCalculator = new AddressCalculator();

// 设置频率（1-4）
addressCalculator.SetFrequency(2);  // 设置为3350MHz

// 设置温度（根据ComboBox索引）
addressCalculator.SetTemperatureFromComboBoxIndex(5);  // 设置为第6个温度区间

// 获取地址数组
var normalAddresses = addressCalculator.GetNormalAddresses();
var channelAddresses = addressCalculator.GetChannelAddresses();

// 获取温度区间
string range = TemperatureRangeManager.GetRange(25.5f);  // 返回 "20<T<=30"
int comboBoxIndex = TemperatureRangeManager.GetComboBoxIndex(25.5f);  // 返回 8
```

### 4.2 在WinForms中使用

```csharp
public partial class MainForm : Form
{
    private AddressCalculator _addressCalculator = new AddressCalculator();
    private TemperatureRangeManager _tempManager = new TemperatureRangeManager();

    public MainForm()
    {
        InitializeComponent();

        // 初始化温度下拉框
        comboBoxtemp.Items.AddRange(TemperatureRangeManager.GetAllRanges());
        comboBoxtemp.SelectedIndex = 0;

        // 绑定频率按钮事件
        button3330.Click += (s, e) => OnFrequencySelected(1);
        button3350.Click += (s, e) => OnFrequencySelected(2);
        button3370.Click += (s, e) => OnFrequencySelected(3);
        button3390.Click += (s, e) => OnFrequencySelected(4);

        // 绑定温度下拉框事件
        comboBoxtemp.SelectedIndexChanged += OnTemperatureSelected;
    }

    private void OnFrequencySelected(int frequencyIndex)
    {
        _addressCalculator.SetFrequency(frequencyIndex);
        UpdateAllControlAddresses();
    }

    private void OnTemperatureSelected(object sender, EventArgs e)
    {
        _addressCalculator.SetTemperatureFromComboBoxIndex(comboBoxtemp.SelectedIndex);
        UpdateAllControlAddresses();
    }

    private void UpdateAllControlAddresses()
    {
        var normalAddrs = _addressCalculator.GetNormalAddresses();
        var channelAddrs = _addressCalculator.GetChannelAddresses();

        // 更新各个FlowLayoutPanel中的控件
        UpdatePanelControls(flowLayoutPanel1, normalAddrs, 0, 10);
        UpdatePanelControls(flowLayoutPanel2, normalAddrs, 10, 10);
        // ... 其他面板
    }
}
```

## 5. 注意事项

1. **频率索引范围**：1-4，超出范围会抛出异常
2. **温度索引计算**：
   - ComboBox索引0 → tem=1
   - ComboBox索引1 → tem=2
   - ComboBox索引n (n≥2) → tem=2×n
3. **地址格式**：返回的地址字符串格式为"0xXXXX"（十六进制大写）
4. **线程安全**：如果需要在多线程环境中使用，请自行添加线程锁
5. **数值范围**：确保输入的温度值在合理范围内（-60℃到+90℃以上）

这个总结包含了所有地址计算和温度区间相关的代码，可以直接移植到其他程序中使用。代码经过整理和注释，结构清晰，易于理解和维护。